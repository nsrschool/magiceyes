<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตาวิเศษ NSR - โรงเรียนหนองสำโรงวิทยา</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 pb-20 md:pb-0 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-emerald-600 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-2 cursor-pointer" onclick="app.setView('dashboard')">
                <div class="bg-white p-1.5 rounded-full flex items-center justify-center">
                    <i data-lucide="eye" class="text-emerald-600 w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">ตาวิเศษ NSR</h1>
                    <p class="text-xs text-emerald-100 opacity-90">รร.หนองสำโรงวิทยา</p>
                </div>
            </div>

            <!-- Desktop Nav -->
            <nav class="hidden md:flex space-x-1">
                <button onclick="app.setView('dashboard')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium"><i data-lucide="home" class="w-4 h-4"></i><span>หน้าหลัก</span></button>
                <button onclick="app.setView('report')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium"><i data-lucide="plus-circle" class="w-4 h-4"></i><span>แจ้งเหตุ</span></button>
                <button onclick="app.setView('search')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium"><i data-lucide="list-checks" class="w-4 h-4"></i><span>สรุปรายการ</span></button>
                <button onclick="app.setView('awards')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium"><i data-lucide="trophy" class="w-4 h-4"></i><span>เกียรติยศ</span></button>
                <button onclick="app.setView('students')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium"><i data-lucide="users" class="w-4 h-4"></i><span>รายชื่อ</span></button>
                <button onclick="app.setView('executive')" class="flex items-center space-x-1 px-3 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-800 transition-colors text-sm font-medium shadow-sm border border-emerald-500"><i data-lucide="briefcase" class="w-4 h-4"></i><span>ผู้บริหาร</span></button>
                <button onclick="app.setView('settings')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium" title="ตั้งค่าตัวเลือก"><i data-lucide="settings" class="w-4 h-4"></i></button>
            </nav>

            <!-- Mobile Menu Toggle -->
            <button class="md:hidden p-2" onclick="app.toggleMobileMenu()"><i data-lucide="menu" id="menu-icon"></i></button>
        </div>

        <!-- Mobile Nav -->
        <div id="mobile-menu" class="hidden md:hidden bg-emerald-700 pb-2 px-2 shadow-inner">
            <button onclick="app.setView('dashboard'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600"><i data-lucide="home" class="w-4 h-4"></i><span>หน้าหลัก</span></button>
            <button onclick="app.setView('report'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600"><i data-lucide="plus-circle" class="w-4 h-4"></i><span>บันทึกการแจ้งเหตุ</span></button>
            <button onclick="app.setView('search'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600"><i data-lucide="list-checks" class="w-4 h-4"></i><span>สรุปรายการแจ้งเหตุ</span></button>
            <button onclick="app.setView('awards'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600"><i data-lucide="trophy" class="w-4 h-4"></i><span>ทำเนียบเกียรติยศ</span></button>
            <button onclick="app.setView('students'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600"><i data-lucide="users" class="w-4 h-4"></i><span>จัดการรายชื่อนักเรียน</span></button>
            <button onclick="app.setView('settings'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600"><i data-lucide="settings" class="w-4 h-4"></i><span>ตั้งค่าตัวเลือก</span></button>
            <button onclick="app.setView('executive'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-yellow-300 font-bold bg-emerald-800 hover:bg-emerald-900"><i data-lucide="briefcase" class="w-4 h-4"></i><span>สรุปสำหรับผู้บริหาร</span></button>
        </div>
    </header>

    <!-- Notification Toast -->
    <div id="notification" class="fixed top-20 right-4 z-50 transform transition-all duration-300 translate-x-full opacity-0">
        <div id="notification-content" class="bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center">
            <i data-lucide="check-circle-2" class="mr-2 w-5 h-5"></i>
            <span id="notification-text">บันทึกข้อมูลสำเร็จ!</span>
        </div>
    </div>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow py-6 max-w-6xl mx-auto w-full px-4"></main>

    <!-- Footer -->
    <footer class="text-center text-gray-400 text-xs py-6 mt-auto">
        <p>© สภานักเรียนโรงเรียนหนองสำโรงวิทยา</p>
        <p>สร้างสรรค์กิจกรรมเพื่อสิ่งแวดล้อมที่ยั่งยืน</p>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // **********************************************************
        // นำ URL ที่ได้จากการ Deploy Google Apps Script มาวางตรงนี้
        // **********************************************************
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHrN4LZpjniCHV_SujPvO9oFKvsGRccWZmrEHM-plDq7BEmv6yubQiwlIFUKZvAcwF1Q/exec"; 

        // --- Data Constants ---
        const DEFAULT_LOCATIONS = [
            "โรงอาหาร", "หน้าอาคารเรียน", "สนามกีฬา/สแตนด์เชียร์", 
            "ลานอเนกประสงค์", "ห้องน้ำ", "สวนหย่อม", "อื่นๆ"
        ];
        const DEFAULT_TRASH_TYPES = [
            "พลาสติก (แก้ว/ถุง)", "เศษอาหาร", "กระดาษ/กล่องนม", 
            "ขวดน้ำ", "ขยะอันตราย", "อื่นๆ"
        ];
        const DEFAULT_CLASS_LEVELS = [
            "ป.1/1", "ป.1/2", "ป.2", "ป.3/1", "ป.3/2", "ป.4/1", "ป.4/2", "ป.5/1", "ป.5/2", "ป.6/1", "ป.6/2",
            "ม.1/1", "ม.1/2", "ม.2/1", "ม.2/2", "ม.3/1", "ม.3/2"
        ];

        const INITIAL_STUDENTS = [
            { id: "1001", name: "ด.ช.ตาวิเศษ รักดี", classLevel: "ม.1/1", points: 5 },
            { id: "1002", name: "ด.ญ.ใจใส สะอาด", classLevel: "ม.2/1", points: 12 },
            { id: "1003", name: "นายจิตอาสา พัฒนา", classLevel: "ม.4/1", points: 8 }
        ];

        const INITIAL_REPORTS = [
            { id: 1, name: "ด.ช. รักเรียน เพียรศึกษา", studentId: "12345", classLevel: "ม.1/2", location: "โรงอาหาร", trashType: "พลาสติก (แก้ว/ถุง)", timestamp: new Date(Date.now() - 86400000).toISOString(), reporterName: "ด.ช.ตาวิเศษ รักดี" }
        ];

        const app = {
            state: {
                view: 'dashboard', 
                reports: [],
                students: [],
                config: { locations: [], trashTypes: [], classLevels: [] },
                isMobileMenuOpen: false,
                chartInstances: [],
                editingReportId: null
            },

            init() {
                const savedReports = localStorage.getItem('magicEyeReports');
                this.state.reports = savedReports ? JSON.parse(savedReports) : INITIAL_REPORTS;

                const savedStudents = localStorage.getItem('magicEyeStudents');
                this.state.students = savedStudents ? JSON.parse(savedStudents) : INITIAL_STUDENTS;

                const savedConfig = localStorage.getItem('magicEyeConfig');
                this.state.config = savedConfig ? JSON.parse(savedConfig) : {
                    locations: [...DEFAULT_LOCATIONS],
                    trashTypes: [...DEFAULT_TRASH_TYPES],
                    classLevels: [...DEFAULT_CLASS_LEVELS]
                };

                this.render();
            },

            saveData() {
                try {
                    localStorage.setItem('magicEyeReports', JSON.stringify(this.state.reports));
                    localStorage.setItem('magicEyeStudents', JSON.stringify(this.state.students));
                    localStorage.setItem('magicEyeConfig', JSON.stringify(this.state.config));
                } catch (e) { alert("หน่วยความจำเต็ม ไม่สามารถบันทึกข้อมูลบางส่วนได้"); }
            },

            // --- Google Sheets Sync Logic ---
            async syncStudentsToCloud() {
                if (!GOOGLE_SCRIPT_URL) return;
                try {
                    // Send students list to Google Sheet (Action: sync_students)
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'sync_students',
                            students: this.state.students
                        })
                    });
                    console.log("Synced students to cloud");
                } catch (error) {
                    console.error("Sync error:", error);
                }
            },

            setView(viewName) {
                this.state.view = viewName;
                if(viewName === 'report' && !this.state.editingReportId) this.state.editingReportId = null;
                if(viewName !== 'report') this.state.editingReportId = null;
                this.render();
                window.scrollTo(0, 0);
            },

            toggleMobileMenu() {
                this.state.isMobileMenuOpen = !this.state.isMobileMenuOpen;
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden', !this.state.isMobileMenuOpen);
            },

            showNotification(msg = "บันทึกข้อมูลสำเร็จ!") {
                const el = document.getElementById('notification');
                document.getElementById('notification-text').textContent = msg;
                el.classList.remove('translate-x-full', 'opacity-0');
                setTimeout(() => el.classList.add('translate-x-full', 'opacity-0'), 3000);
            },

            async addReport(formData) {
                const submitBtn = document.getElementById('submit-btn');
                const btnText = document.getElementById('submit-btn-text');
                const btnLoader = document.getElementById('submit-btn-loader');
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btnText.textContent = 'กำลังบันทึก...';
                btnLoader.classList.remove('hidden');

                const isNew = !this.state.editingReportId;
                let reportToSave = {};

                if (!isNew) {
                    const idx = this.state.reports.findIndex(r => r.id === this.state.editingReportId);
                    if (idx !== -1) {
                        this.state.reports[idx] = { ...this.state.reports[idx], ...formData };
                        reportToSave = this.state.reports[idx];
                        this.saveData();
                        this.showNotification("แก้ไขข้อมูลเรียบร้อย");
                    }
                } else {
                    reportToSave = { ...formData, id: Date.now(), timestamp: new Date().toISOString() };
                    
                    // Logic: ให้คะแนนผู้แจ้ง +1
                    if (formData.reporterName) {
                        const rIdx = this.state.students.findIndex(s => s.name === formData.reporterName);
                        if (rIdx !== -1) {
                            this.state.students[rIdx].points = (this.state.students[rIdx].points || 0) + 1;
                        }
                    }

                    // Logic: หักคะแนนผู้ถูกแจ้ง -1
                    if (formData.name) {
                        const oIdx = this.state.students.findIndex(s => s.name === formData.name);
                        if (oIdx !== -1) {
                            this.state.students[oIdx].points = (this.state.students[oIdx].points || 0) - 1;
                        }
                    }

                    // Sync updated points to cloud immediately
                    this.syncStudentsToCloud();

                    this.state.reports.unshift(reportToSave);
                    this.saveData();
                    
                    // Send Report to Google Sheets
                    if (GOOGLE_SCRIPT_URL) {
                        try {
                            await fetch(GOOGLE_SCRIPT_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ...reportToSave, action: 'save_report' })
                            });
                        } catch (error) { console.error("Error sending report:", error); }
                    }
                    this.showNotification(`บันทึกสำเร็จ! ผู้แจ้ง +1, ผู้ถูกแจ้ง -1`);
                }

                this.state.editingReportId = null;
                this.setView('search');
            },

            editReport(id) {
                this.state.editingReportId = id;
                this.state.view = 'report';
                this.render();
                window.scrollTo(0, 0);
            },
            cancelEdit() {
                this.state.editingReportId = null;
                this.setView('search');
            },
            deleteReport(id) {
                if(confirm('คุณต้องการลบรายการนี้ใช่หรือไม่?')) {
                    this.state.reports = this.state.reports.filter(r => r.id !== id);
                    this.saveData();
                    this.render();
                    this.showNotification('ลบรายการเรียบร้อย');
                }
            },

            addConfigItem(type, value) {
                if (!value.trim()) return;
                this.state.config[type].push(value.trim());
                this.saveData();
                this.render();
            },
            removeConfigItem(type, index) {
                if (confirm("ต้องการลบรายการนี้?")) {
                    this.state.config[type].splice(index, 1);
                    this.saveData();
                    this.render();
                }
            },
            resetConfig(type) {
                if (confirm("ต้องการรีเซ็ตเป็นค่าเริ่มต้น?")) {
                    if (type === 'locations') this.state.config.locations = [...DEFAULT_LOCATIONS];
                    if (type === 'trashTypes') this.state.config.trashTypes = [...DEFAULT_TRASH_TYPES];
                    if (type === 'classLevels') this.state.config.classLevels = [...DEFAULT_CLASS_LEVELS];
                    this.saveData();
                    this.render();
                }
            },

            addStudent(studentData) {
                this.state.students.push({
                    id: studentData.id || Date.now().toString(),
                    name: studentData.name,
                    classLevel: studentData.classLevel,
                    points: 0
                });
                this.saveData();
                this.syncStudentsToCloud(); // Sync new student
                this.render();
                this.showNotification("เพิ่มรายชื่อนักเรียนแล้ว");
            },

            deleteStudent(index) {
                if (confirm("ยืนยันการลบรายชื่อนี้?")) {
                    this.state.students.splice(index, 1);
                    this.saveData();
                    this.syncStudentsToCloud(); // Sync deletion
                    this.render();
                }
            },

            handleExcelImport(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        let count = 0;
                        let startIndex = 0;
                        if (jsonData[0] && (
                            (typeof jsonData[0][0] === 'string' && jsonData[0][0].includes('ชั้น')) ||
                            (typeof jsonData[0][3] === 'string' && jsonData[0][3].includes('ชื่อ'))
                        )) { startIndex = 1; }

                        for (let i = startIndex; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row[0] && row[3]) { 
                                const prefix = row[2] || '';
                                const firstName = row[3] || '';
                                const lastName = row[4] || '';
                                const fullName = `${prefix}${firstName} ${lastName}`.trim();
                                const classVal = row[0] || '-';
                                this.state.students.push({
                                    id: Date.now().toString() + i,
                                    name: fullName,
                                    classLevel: classVal,
                                    points: 0
                                });
                                count++;
                            }
                        }
                        this.saveData();
                        this.syncStudentsToCloud(); // Sync imported students
                        this.showNotification(`นำเข้าสำเร็จ ${count} รายชื่อ`);
                        this.render();
                    } catch (err) { alert("เกิดข้อผิดพลาดในการอ่านไฟล์ Excel: " + err.message); }
                };
                reader.readAsArrayBuffer(file);
            },

            readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            // --- UI Rendering ---
            render() {
                const main = document.getElementById('main-content');
                main.innerHTML = ''; 
                this.state.chartInstances.forEach(chart => chart.destroy());
                this.state.chartInstances = [];

                switch (this.state.view) {
                    case 'dashboard': main.innerHTML = this.getDashboardHTML(); break;
                    case 'report': main.innerHTML = this.getReportFormHTML(); this.attachFormListeners(); break;
                    case 'search': main.innerHTML = this.getSearchHTML(); this.attachSearchListeners(); break;
                    case 'awards': main.innerHTML = this.getAwardsHTML(); break;
                    case 'executive': main.innerHTML = this.getExecutiveHTML(); break;
                    case 'students': main.innerHTML = this.getStudentManagerHTML(); this.attachStudentListeners(); break;
                    case 'settings': main.innerHTML = this.getSettingsHTML(); break;
                }
                lucide.createIcons();
                setTimeout(() => this.renderCharts(), 0);
            },

            getDashboardHTML() {
                const total = this.state.reports.length;
                const locCounts = {};
                this.state.reports.forEach(r => locCounts[r.location] = (locCounts[r.location] || 0) + 1);
                const topLocs = Object.entries(locCounts).sort((a,b) => b[1]-a[1]).slice(0,3);
                const renderList = (items) => items.length === 0 ? `<li class="text-sm text-gray-400">ยังไม่มีข้อมูล</li>` : items.map(([name, count], idx) => `<li class="flex justify-between items-center py-2 border-b last:border-0 border-gray-100"><span class="text-gray-700 text-sm"><span class="font-bold mr-2 text-emerald-600">#${idx+1}</span> ${name}</span><span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-bold">${count}</span></li>`).join('');
                return `<div class="space-y-6 animate-fade-in"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-gradient-to-br from-emerald-600 to-teal-700 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden"><div class="relative z-10"><h3 class="text-emerald-100 text-sm font-medium mb-1">สถิติการแจ้งเหตุรวม</h3><p class="text-5xl font-bold tracking-tight">${total}</p><p class="text-sm mt-2 opacity-80">ครั้งในภาคเรียนนี้</p></div><i data-lucide="bar-chart-2" class="absolute right-0 bottom-0 text-emerald-500 opacity-20 w-32 h-32 -mr-6 -mb-6"></i></div><div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100"><h3 class="text-gray-800 font-bold mb-4 flex items-center"><i data-lucide="alert-triangle" class="w-5 h-5 mr-2 text-orange-500"></i> จุดที่พบขยะบ่อยที่สุด</h3><ul>${renderList(topLocs)}</ul></div></div></div>`;
            },

            getReportFormHTML() {
                const options = (arr, selected) => arr.map(i => `<option value="${i}" ${i === selected ? 'selected' : ''}>${i}</option>`).join('');
                const isEditing = !!this.state.editingReportId;
                const editingReport = isEditing ? this.state.reports.find(r => r.id === this.state.editingReportId) : null;
                let reporterClass = "";
                if (isEditing && editingReport.reporterName) {
                    const reporter = this.state.students.find(s => s.name === editingReport.reporterName);
                    if (reporter) reporterClass = reporter.classLevel;
                }

                return `
                    <div class="max-w-2xl mx-auto animate-fade-in pb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><i data-lucide="${isEditing ? 'edit' : 'plus-circle'}" class="mr-3 text-emerald-600 w-8 h-8"></i> ${isEditing ? 'แก้ไขการแจ้งเหตุ' : 'บันทึกการแจ้งเหตุ'}</h2>
                        <form id="report-form" class="bg-white p-6 rounded-2xl shadow-lg space-y-5 border border-gray-100">
                            <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                <label class="block text-sm font-bold text-emerald-800 mb-2 flex items-center"><i data-lucide="user" class="w-4 h-4 mr-2"></i> ผู้แจ้ง (รับ 1 คะแนนความดี)</label>
                                <div class="grid grid-cols-2 gap-3 mb-2">
                                    <select id="reporter-class-filter" class="w-full p-2 bg-white border border-emerald-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:outline-none"><option value="">เลือกชั้น (ผู้แจ้ง)</option>${options(this.state.config.classLevels, reporterClass)}</select>
                                    <select name="reporterName" id="reporter-name-select" ${isEditing ? '' : 'disabled'} class="w-full p-2 bg-gray-100 border border-emerald-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:outline-none disabled:opacity-50"><option value="">-- เลือกชื่อ --</option></select>
                                </div>
                            </div>
                            <hr class="border-gray-100">
                            <div><label class="block text-sm font-semibold text-gray-700 mb-2">ระดับชั้น (ผู้ถูกแจ้ง)</label><select name="classLevel" id="offender-class-select" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none"><option value="">-- เลือกระดับชั้น --</option>${options(this.state.config.classLevels, isEditing ? editingReport.classLevel : '')}</select></div>
                            <div><label class="block text-sm font-semibold text-gray-700 mb-2">ชื่อ-นามสกุล (ผู้ถูกแจ้ง)</label><select name="name" id="offender-name-select" required ${isEditing ? '' : 'disabled'} class="w-full p-3 bg-gray-100 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none disabled:opacity-50"><option value="">-- กรุณาเลือกระดับชั้นก่อน --</option></select></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">จุดที่พบ</label><select name="location" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none"><option value="">-- เลือกจุดที่พบ --</option>${options(this.state.config.locations, isEditing ? editingReport.location : '')}</select></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ประเภทขยะ</label><select name="trashType" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none"><option value="">-- เลือกประเภทขยะ --</option>${options(this.state.config.trashTypes, isEditing ? editingReport.trashType : '')}</select></div>
                            </div>
                            <div><label class="block text-sm font-semibold text-gray-700 mb-2">รายละเอียดเหตุการณ์</label><textarea name="details" rows="3" placeholder="ระบุรายละเอียดเพิ่มเติม (ไม่บังคับ)" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none">${isEditing && editingReport.details ? editingReport.details : ''}</textarea></div>
                            <div><label class="block text-sm font-semibold text-gray-700 mb-2">แนบรูปภาพ</label><input id="image-input" type="file" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100"/></div>
                            <div class="flex gap-3">${isEditing ? `<button type="button" onclick="app.cancelEdit()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 rounded-xl shadow-md transition-all">ยกเลิก</button>` : ''}<button id="submit-btn" type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-md hover:shadow-lg transition-all flex justify-center items-center"><i data-lucide="loader-2" id="submit-btn-loader" class="hidden animate-spin mr-2 w-5 h-5"></i><span id="submit-btn-text">${isEditing ? 'บันทึกการแก้ไข' : 'บันทึกข้อมูล'}</span></button></div>
                        </form>
                    </div>`;
            },

            attachFormListeners() {
                const form = document.getElementById('report-form');
                if (form) {
                    const fileInput = document.getElementById('image-input');
                    const isEditing = !!this.state.editingReportId;
                    const editingReport = isEditing ? this.state.reports.find(r => r.id === this.state.editingReportId) : null;
                    const updateStudentDropdown = (classLevel, targetSelectId, selectedValue = null) => {
                        const targetSelect = document.getElementById(targetSelectId);
                        if (!targetSelect) return;
                        targetSelect.innerHTML = '<option value="">-- เลือกรายชื่อ --</option>';
                        if (!classLevel) { targetSelect.disabled = true; targetSelect.classList.add('bg-gray-100'); targetSelect.classList.remove('bg-white'); return; }
                        const filtered = this.state.students.filter(s => s.classLevel === classLevel);
                        if (filtered.length === 0) { targetSelect.innerHTML = '<option value="">-- ไม่พบรายชื่อในชั้นนี้ --</option>'; targetSelect.disabled = true; } 
                        else {
                            filtered.sort((a, b) => a.name.localeCompare(b.name, 'th'));
                            filtered.forEach(s => { const opt = document.createElement('option'); opt.value = s.name; opt.textContent = s.name; if(selectedValue === s.name) opt.selected = true; targetSelect.appendChild(opt); });
                            targetSelect.disabled = false; targetSelect.classList.remove('bg-gray-100'); targetSelect.classList.add('bg-white');
                        }
                    };
                    const reporterClassFilter = document.getElementById('reporter-class-filter');
                    if (reporterClassFilter) {
                        reporterClassFilter.addEventListener('change', (e) => updateStudentDropdown(e.target.value, 'reporter-name-select'));
                        if(isEditing && reporterClassFilter.value) updateStudentDropdown(reporterClassFilter.value, 'reporter-name-select', editingReport.reporterName);
                    }
                    const offenderClassSelect = document.getElementById('offender-class-select');
                    if (offenderClassSelect) {
                        offenderClassSelect.addEventListener('change', (e) => updateStudentDropdown(e.target.value, 'offender-name-select'));
                        if(isEditing && offenderClassSelect.value) updateStudentDropdown(offenderClassSelect.value, 'offender-name-select', editingReport.name);
                    }
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());
                        if (fileInput && fileInput.files[0]) { try { data.image = await this.readFileAsDataURL(fileInput.files[0]); } catch (err) {} }
                        this.addReport(data);
                    });
                }
            },

            getSearchHTML() {
                return `<div class="max-w-4xl mx-auto animate-fade-in pb-12"><h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><i data-lucide="list-checks" class="mr-3 text-emerald-600 w-8 h-8"></i> สรุปรายการแจ้งเหตุ</h2><div class="bg-white p-4 rounded-2xl shadow-md mb-8 border border-gray-200 sticky top-20 z-10"><div class="relative"><i data-lucide="search" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i><input id="search-input" type="text" placeholder="ค้นหาชื่อ, ชั้น, หรือ ประเภทขยะ..." class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none text-gray-700"></div></div><div id="search-results" class="space-y-8"><div class="text-center text-gray-400 py-12">กำลังโหลด...</div></div></div>`;
            },

            attachSearchListeners() {
                const input = document.getElementById('search-input');
                const resultsDiv = document.getElementById('search-results');
                const renderReports = (filter = "") => {
                    const term = filter.toLowerCase();
                    let filtered = this.state.reports.filter(r => r.name.toLowerCase().includes(term) || r.classLevel.toLowerCase().includes(term) || (r.reporterName && r.reporterName.toLowerCase().includes(term)) || r.trashType.toLowerCase().includes(term));
                    if (filtered.length === 0) { resultsDiv.innerHTML = '<div class="text-center text-gray-500 py-8">ไม่พบข้อมูล</div>'; return; }
                    const grouped = {};
                    filtered.forEach(r => {
                        const dateKey = new Date(r.timestamp).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                        if (!grouped[dateKey]) grouped[dateKey] = [];
                        grouped[dateKey].push(r);
                    });
                    let html = "";
                    for (const date in grouped) {
                        html += `<div class="animate-fade-in"><h3 class="text-sm font-bold text-gray-500 mb-3 bg-gray-100 inline-block px-3 py-1 rounded-full border border-gray-200 sticky top-0">${date}</h3><div class="space-y-3">`;
                        grouped[date].forEach(r => {
                            html += `<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative group hover:shadow-md transition-shadow"><div class="flex justify-between items-start mb-2"><div class="flex items-center gap-2"><span class="bg-emerald-100 text-emerald-800 text-xs font-bold px-2 py-1 rounded">${r.classLevel}</span><span class="text-xs text-gray-400 flex items-center"><i data-lucide="clock" class="w-3 h-3 mr-1"></i>${new Date(r.timestamp).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</span></div><div class="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="app.editReport(${r.id})" class="text-blue-500 hover:text-blue-700 p-1 bg-blue-50 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="app.deleteReport(${r.id})" class="text-red-500 hover:text-red-700 p-1 bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div><div class="flex justify-between items-start"><div><h4 class="font-bold text-gray-800 text-lg">${r.name}</h4><p class="text-sm text-gray-600 mt-1"><span class="font-semibold text-gray-500">พบที่:</span> ${r.location} <span class="mx-2 text-gray-300">|</span> <span class="font-semibold text-gray-500">ขยะ:</span> ${r.trashType}</p>${r.details ? `<p class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded">"${r.details}"</p>` : ''}<p class="text-xs text-emerald-600 mt-2 flex items-center"><i data-lucide="user-check" class="w-3 h-3 mr-1"></i> แจ้งโดย: ${r.reporterName || '-'}</p></div>${r.image ? `<div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden border border-gray-200 flex-shrink-0 ml-2"><img src="${r.image}" class="w-full h-full object-cover"></div>` : ''}</div></div>`;
                        });
                        html += `</div></div><div class="h-4"></div>`;
                    }
                    resultsDiv.innerHTML = html;
                    lucide.createIcons();
                };
                renderReports();
                input.addEventListener('input', (e) => renderReports(e.target.value));
            },

            getAwardsHTML() {
                const stats = {};
                this.state.config.classLevels.forEach(c => stats[c] = 0);
                this.state.reports.forEach(r => { if (stats[r.classLevel] !== undefined) stats[r.classLevel]++; else stats[r.classLevel] = (stats[r.classLevel] || 0) + 1; });
                const topClean = Object.entries(stats).filter(i => i[1] === 0).map(i => i[0]);
                const topCleanHTML = topClean.length > 0 ? `<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-8">${topClean.map(room => `<div class="bg-white border-2 border-emerald-100 text-center py-3 rounded-xl shadow-sm"><span class="text-emerald-600 font-bold text-lg">${room}</span></div>`).join('')}</div>` : `<div class="text-center text-gray-500 italic py-4 bg-white rounded-xl mb-8 border border-gray-100">เดือนนี้ทุกห้องมีการแจ้งเหตุ สู้ใหม่เดือนหน้านะ!</div>`;
                return `<div class="animate-fade-in pb-12"><div class="text-center mb-10"><div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-yellow-100 mb-4 shadow-sm"><i data-lucide="trophy" class="w-8 h-8 text-yellow-500"></i></div><h2 class="text-3xl font-bold text-gray-800">ทำเนียบเกียรติยศ</h2><p class="text-gray-500">ติดตามความสะอาดของแต่ละห้องเรียน</p></div><div class="mb-8"><h3 class="font-bold text-lg text-emerald-800 mb-4 flex items-center"><i data-lucide="sparkles" class="mr-2 w-5 h-5"></i> ห้องเรียนต้นแบบ (ไร้ขยะ)</h3>${topCleanHTML}</div><div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100"><h3 class="font-bold text-gray-700 mb-6 flex items-center"><i data-lucide="bar-chart-3" class="mr-2 w-5 h-5"></i> สถิติความสะอาด (กราฟ)</h3><div class="chart-container" style="height: 400px;"><canvas id="awardsChart"></canvas></div><p class="text-center text-xs text-gray-400 mt-4">* กราฟแสดงจำนวนครั้งที่ถูกแจ้งเหตุ (ยิ่งน้อยยิ่งดี)</p></div></div>`;
            },

            getExecutiveHTML() {
                const total = this.state.reports.length;
                const today = new Date().toDateString();
                const todayCount = this.state.reports.filter(r => new Date(r.timestamp).toDateString() === today).length;
                const trashCounts = {};
                this.state.reports.forEach(r => trashCounts[r.trashType] = (trashCounts[r.trashType] || 0) + 1);
                const topTrash = Object.entries(trashCounts).sort((a,b) => b[1]-a[1])[0] || ['-', 0];
                return `<div class="animate-fade-in pb-12"><div class="flex items-center justify-between mb-8"><div><h2 class="text-2xl font-bold text-gray-800">Dashboard ผู้บริหาร</h2><p class="text-sm text-gray-500">สรุปสถานการณ์ความสะอาดและวินัยนักเรียน</p></div><div class="text-right"><span class="bg-emerald-100 text-emerald-800 text-xs font-bold px-3 py-1 rounded-full">อัปเดตล่าสุด: วันนี้</span></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200"><p class="text-sm text-gray-500 mb-1">แจ้งเหตุวันนี้</p><p class="text-4xl font-bold text-emerald-600">${todayCount}</p><p class="text-xs text-gray-400 mt-2">จากทั้งหมด ${total} ครั้ง</p></div><div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200"><p class="text-sm text-gray-500 mb-1">ขยะที่พบมากสุด</p><p class="text-xl font-bold text-gray-800 truncate" title="${topTrash[0]}">${topTrash[0]}</p><p class="text-xs text-gray-400 mt-2">จำนวน ${topTrash[1]} ครั้ง</p></div><div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200"><p class="text-sm text-gray-500 mb-1">สถานะภาพรวม</p><p class="text-lg font-bold ${todayCount > 5 ? 'text-orange-500' : 'text-emerald-500'}">${todayCount > 5 ? 'ต้องเฝ้าระวัง' : 'ปกติ'}</p><p class="text-xs text-gray-400 mt-2">${todayCount > 5 ? 'มีการแจ้งเหตุสูงกว่าปกติ' : 'อยู่ในเกณฑ์ที่ดี'}</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100"><h3 class="font-bold text-gray-700 mb-4">สัดส่วนประเภทขยะ</h3><div class="chart-container"><canvas id="trashChart"></canvas></div></div><div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100"><h3 class="font-bold text-gray-700 mb-4">จุดเสี่ยงที่พบขยะบ่อย</h3><div class="chart-container"><canvas id="locationChart"></canvas></div></div></div><div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100"><h3 class="font-bold text-gray-700 mb-4">แนวโน้มการแจ้งเหตุ (7 วันย้อนหลัง)</h3><div class="chart-container" style="height: 250px;"><canvas id="trendChart"></canvas></div></div></div>`;
            },

            getSettingsHTML() {
                const renderList = (items, type) => items.map((item, idx) => `<div class="flex justify-between items-center p-2 hover:bg-gray-50 border-b last:border-0 border-gray-100"><span class="text-sm text-gray-700">${item}</span><button onclick="app.removeConfigItem('${type}', ${idx})" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></div>`).join('');
                const renderCard = (title, icon, type, items, placeholder) => `<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"><div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center"><h3 class="font-bold text-gray-700 flex items-center text-sm"><i data-lucide="${icon}" class="w-4 h-4 mr-2"></i>${title}</h3><button onclick="app.resetConfig('${type}')" class="text-xs text-blue-500 hover:text-blue-700 underline">รีเซ็ต</button></div><div class="max-h-60 overflow-y-auto">${renderList(items, type)}</div><div class="p-3 border-t border-gray-100"><form onsubmit="event.preventDefault(); app.addConfigItem('${type}', this.elements[0].value); this.reset();" class="flex gap-2"><input type="text" placeholder="${placeholder}" required class="flex-1 p-2 text-sm border rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none"><button type="submit" class="bg-emerald-600 text-white px-3 rounded hover:bg-emerald-700"><i data-lucide="plus" class="w-4 h-4"></i></button></form></div></div>`;
                return `<div class="max-w-4xl mx-auto animate-fade-in pb-12"><h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><i data-lucide="settings" class="mr-3 text-emerald-600 w-8 h-8"></i> ตั้งค่าตัวเลือก</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6">${renderCard('ระดับชั้น', 'users', 'classLevels', this.state.config.classLevels, 'เช่น ม.1/4')}${renderCard('จุดที่พบ', 'map-pin', 'locations', this.state.config.locations, 'เช่น หน้าห้องสมุด')}${renderCard('ประเภทขยะ', 'trash', 'trashTypes', this.state.config.trashTypes, 'เช่น โฟม')}</div></div>`;
            },

            getStudentManagerHTML() {
                const list = this.state.students.map((s, idx) => `<tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0"><td class="p-3 text-sm">${idx + 1}</td><td class="p-3 text-sm font-medium text-gray-800">${s.name}</td><td class="p-3 text-sm text-gray-600">${s.classLevel}</td><td class="p-3 text-center"><span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-bold">${s.points || 0} คะแนน</span></td><td class="p-3 text-right"><button onclick="app.deleteStudent(${idx})" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
                return `<div class="max-w-4xl mx-auto animate-fade-in pb-12"><div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-bold text-gray-800 flex items-center"><i data-lucide="users" class="mr-3 text-emerald-600 w-8 h-8"></i> จัดการรายชื่อนักเรียน</h2><div class="text-sm text-gray-500">ทั้งหมด: <span class="font-bold text-emerald-600">${this.state.students.length}</span> คน</div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8"><div class="bg-white p-5 rounded-2xl shadow-sm border border-emerald-100"><h3 class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="file-spreadsheet" class="mr-2 w-5 h-5 text-green-600"></i> นำเข้าไฟล์ Excel</h3><p class="text-xs text-gray-500 mb-4 bg-gray-50 p-2 rounded border border-gray-100"><strong>รูปแบบคอลัมน์:</strong><br>A=ชั้นเรียน, B=เลขที่, C=คำนำหน้า, D=ชื่อ, E=นามสกุล</p><label class="block w-full text-center p-3 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-emerald-400 transition-colors"><span class="text-sm text-gray-500" id="excel-label">คลิกเพื่อเลือกไฟล์ .xlsx</span><input type="file" id="excel-input" accept=".xlsx, .xls" class="hidden"></label></div><div class="bg-white p-5 rounded-2xl shadow-sm border border-blue-100"><h3 class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="user-plus" class="mr-2 w-5 h-5 text-blue-600"></i> เพิ่มรายชื่อทีละคน</h3><form id="add-student-form" class="flex gap-2"><input type="text" name="name" required placeholder="ชื่อ-สกุล" class="flex-1 p-2 bg-gray-50 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"><input type="text" name="classLevel" required placeholder="ชั้น" class="w-20 p-2 bg-gray-50 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"><button type="submit" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"><i data-lucide="plus" class="w-5 h-5"></i></button></form></div></div><div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden"><div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center"><h3 class="font-bold text-gray-700">รายชื่อนักเรียนและคะแนนความดี</h3><input type="text" id="student-filter" placeholder="ค้นหาชื่อ..." class="p-2 border rounded-lg text-sm w-48 focus:outline-none focus:ring-2 focus:ring-emerald-500"></div><div class="overflow-x-auto max-h-[500px]"><table class="w-full text-left"><thead class="bg-gray-100 text-gray-600 font-medium sticky top-0 z-10"><tr><th class="p-3 text-sm w-12">#</th><th class="p-3 text-sm">ชื่อ-นามสกุล</th><th class="p-3 text-sm w-24">ชั้น</th><th class="p-3 text-sm w-24 text-center">คะแนน</th><th class="p-3 text-sm w-16 text-right">ลบ</th></tr></thead><tbody id="student-table-body" class="divide-y text-gray-700">${list || '<tr><td colspan="5" class="p-6 text-center text-gray-400">ยังไม่มีรายชื่อนักเรียน</td></tr>'}</tbody></table></div></div></div>`;
            },

            attachStudentListeners() {
                const excelInput = document.getElementById('excel-input');
                if (excelInput) excelInput.addEventListener('change', (e) => this.handleExcelImport(e));
                const addForm = document.getElementById('add-student-form');
                if (addForm) {
                    addForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const data = new FormData(addForm);
                        this.addStudent({ name: data.get('name'), classLevel: data.get('classLevel') });
                        addForm.reset();
                    });
                }
                const filterInput = document.getElementById('student-filter');
                if (filterInput) {
                    filterInput.addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        document.querySelectorAll('#student-table-body tr').forEach(row => {
                            const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                            row.style.display = name.includes(term) ? '' : 'none';
                        });
                    });
                }
            },

            renderCharts() {
                if (this.state.view === 'awards') {
                    const ctx = document.getElementById('awardsChart');
                    if (!ctx) return;
                    const stats = {};
                    this.state.config.classLevels.forEach(c => stats[c] = 0);
                    this.state.reports.forEach(r => { if (stats[r.classLevel] !== undefined) stats[r.classLevel]++; else stats[r.classLevel] = (stats[r.classLevel] || 0) + 1; });
                    const sorted = Object.entries(stats).sort((a,b) => a[1] - b[1]);
                    this.state.chartInstances.push(new Chart(ctx, { type: 'bar', data: { labels: sorted.map(i => i[0]), datasets: [{ label: 'จำนวนครั้งที่ถูกแจ้งเหตุ', data: sorted.map(i => i[1]), backgroundColor: sorted.map(i => i[1] === 0 ? '#10b981' : (i[1] < 3 ? '#fbbf24' : '#ef4444')), borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } }));
                } else if (this.state.view === 'executive') {
                    const trashCtx = document.getElementById('trashChart');
                    if (trashCtx) {
                        const trashStats = {};
                        this.state.reports.forEach(r => trashStats[r.trashType] = (trashStats[r.trashType] || 0) + 1);
                        this.state.chartInstances.push(new Chart(trashCtx, { type: 'doughnut', data: { labels: Object.keys(trashStats), datasets: [{ data: Object.values(trashStats), backgroundColor: ['#34d399', '#fbbf24', '#60a5fa', '#f87171', '#a78bfa', '#9ca3af'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } }));
                    }
                    const locCtx = document.getElementById('locationChart');
                    if (locCtx) {
                        const locStats = {};
                        this.state.reports.forEach(r => locStats[r.location] = (locStats[r.location] || 0) + 1);
                        const sortedLocs = Object.entries(locStats).sort((a,b) => b[1] - a[1]); 
                        this.state.chartInstances.push(new Chart(locCtx, { type: 'bar', data: { labels: sortedLocs.map(i => i[0]), datasets: [{ label: 'จำนวนครั้ง', data: sortedLocs.map(i => i[1]), backgroundColor: '#f59e0b' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } } }));
                    }
                    const trendCtx = document.getElementById('trendChart');
                    if (trendCtx) {
                        const days = {};
                        for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); days[d.toLocaleDateString('th-TH', {day: 'numeric', month: 'short'})] = 0; }
                        this.state.reports.forEach(r => { const key = new Date(r.timestamp).toLocaleDateString('th-TH', {day: 'numeric', month: 'short'}); if (days[key] !== undefined) days[key]++; });
                        this.state.chartInstances.push(new Chart(trendCtx, { type: 'line', data: { labels: Object.keys(days), datasets: [{ label: 'จำนวนการแจ้งเหตุ', data: Object.values(days), borderColor: '#10b981', tension: 0.3, fill: true, backgroundColor: 'rgba(16, 185, 129, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, suggestedMax: 5 } } } }));
                    }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</body>
</html>