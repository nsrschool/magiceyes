<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตาวิเศษ NSR - โรงเรียนหนองสำโรงวิทยา</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Sarabun) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS for Excel Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #10b981; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #059669; 
        }
        .chart-container {
            position: relative; 
            height: 300px; 
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 pb-20 md:pb-0 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-emerald-600 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-2 cursor-pointer" onclick="app.setView('dashboard')">
                <div class="bg-white p-1.5 rounded-full flex items-center justify-center">
                    <i data-lucide="eye" class="text-emerald-600 w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">ตาวิเศษ NSR</h1>
                    <p class="text-xs text-emerald-100 opacity-90">รร.หนองสำโรงวิทยา</p>
                </div>
            </div>

            <!-- Desktop Nav -->
            <nav class="hidden md:flex space-x-1">
                <button onclick="app.setView('dashboard')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium">
                    <i data-lucide="home" class="w-4 h-4"></i><span>หน้าหลัก</span>
                </button>
                <button onclick="app.setView('report')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i><span>แจ้งเหตุ</span>
                </button>
                <button onclick="app.setView('search')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium">
                    <i data-lucide="list-checks" class="w-4 h-4"></i><span>สรุปรายการ</span>
                </button>
                <button onclick="app.setView('awards')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium">
                    <i data-lucide="trophy" class="w-4 h-4"></i><span>เกียรติยศ</span>
                </button>
                <button onclick="app.setView('students')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium">
                    <i data-lucide="users" class="w-4 h-4"></i><span>รายชื่อ</span>
                </button>
                <button onclick="app.setView('executive')" class="flex items-center space-x-1 px-3 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-800 transition-colors text-sm font-medium shadow-sm border border-emerald-500">
                    <i data-lucide="briefcase" class="w-4 h-4"></i><span>ผู้บริหาร</span>
                </button>
                <button onclick="app.setView('settings')" class="flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-emerald-500 transition-colors text-sm font-medium" title="ตั้งค่าตัวเลือก">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                </button>
            </nav>

            <!-- Mobile Menu Toggle -->
            <button class="md:hidden p-2" onclick="app.toggleMobileMenu()">
                <i data-lucide="menu" id="menu-icon"></i>
            </button>
        </div>

        <!-- Mobile Nav -->
        <div id="mobile-menu" class="hidden md:hidden bg-emerald-700 pb-2 px-2 shadow-inner">
            <button onclick="app.setView('dashboard'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600">
                <i data-lucide="home" class="w-4 h-4"></i><span>หน้าหลัก</span>
            </button>
            <button onclick="app.setView('report'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600">
                <i data-lucide="plus-circle" class="w-4 h-4"></i><span>บันทึกการแจ้งเหตุ</span>
            </button>
            <button onclick="app.setView('search'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600">
                <i data-lucide="list-checks" class="w-4 h-4"></i><span>สรุปรายการแจ้งเหตุ</span>
            </button>
            <button onclick="app.setView('awards'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600">
                <i data-lucide="trophy" class="w-4 h-4"></i><span>ทำเนียบเกียรติยศ</span>
            </button>
            <button onclick="app.setView('students'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600">
                <i data-lucide="users" class="w-4 h-4"></i><span>จัดการรายชื่อนักเรียน</span>
            </button>
            <button onclick="app.setView('settings'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-white hover:bg-emerald-600">
                <i data-lucide="settings" class="w-4 h-4"></i><span>ตั้งค่าตัวเลือก</span>
            </button>
            <button onclick="app.setView('executive'); app.toggleMobileMenu()" class="w-full flex items-center space-x-3 px-4 py-3 text-left border-b border-emerald-600 text-yellow-300 font-bold bg-emerald-800 hover:bg-emerald-900">
                <i data-lucide="briefcase" class="w-4 h-4"></i><span>สรุปสำหรับผู้บริหาร</span>
            </button>
        </div>
    </header>

    <!-- Notification Toast -->
    <div id="notification" class="fixed top-20 right-4 z-50 transform transition-all duration-300 translate-x-full opacity-0">
        <div id="notification-content" class="bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center">
            <i data-lucide="check-circle-2" class="mr-2 w-5 h-5"></i>
            <span id="notification-text">บันทึกข้อมูลสำเร็จ!</span>
        </div>
    </div>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow py-6 max-w-6xl mx-auto w-full px-4">
        <!-- Content will be injected here by JavaScript -->
    </main>

    <!-- Footer -->
    <footer class="text-center text-gray-400 text-xs py-6 mt-auto">
        <p>© สภานักเรียนโรงเรียนหนองสำโรงวิทยา</p>
        <p>สร้างสรรค์กิจกรรมเพื่อสิ่งแวดล้อมที่ยั่งยืน</p>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // --- Configuration ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1hXgFzWwQ_xrwq6U5jm15TxRXn9vckQik0mAF6z2F6OS97OyinIfW5IsoXBNyhe9Qdw/exec"; 

        // --- Data Constants (Defaults) ---
        const DEFAULT_LOCATIONS = [
            "โรงอาหาร", "หน้าอาคารเรียน", "สนามกีฬา/สแตนด์เชียร์", 
            "ลานอเนกประสงค์", "ห้องน้ำ", "สวนหย่อม", "อื่นๆ"
        ];

        const DEFAULT_TRASH_TYPES = [
            "พลาสติก (แก้ว/ถุง)", "เศษอาหาร", "กระดาษ/กล่องนม", 
            "ขวดน้ำ", "ขยะอันตราย", "อื่นๆ"
        ];

        const DEFAULT_CLASS_LEVELS = [
            "ป.1/1", "ป.1/2", "ป.2",
            "ป.3/1", "ป.3/2", "ป.4/1", "ป.4/2",
            "ป.5/1", "ป.5/2", "ป.6/1", "ป.6/2",
            "ม.1/1", "ม.1/2", "ม.2/1", "ม.2/2",
            "ม.3/1", "ม.3/2"
        ];

        // Seed data for students if none exists
        const INITIAL_STUDENTS = [
            { id: "1001", name: "ด.ช.ตาวิเศษ รักดี", classLevel: "ม.1/1", points: 5 },
            { id: "1002", name: "ด.ญ.ใจใส สะอาด", classLevel: "ม.2/1", points: 12 },
            { id: "1003", name: "นายจิตอาสา พัฒนา", classLevel: "ม.4/1", points: 8 }
        ];

        const INITIAL_REPORTS = [
            { id: 1, name: "ด.ช. รักเรียน เพียรศึกษา", studentId: "12345", classLevel: "ม.1/2", location: "โรงอาหาร", trashType: "พลาสติก (แก้ว/ถุง)", timestamp: new Date(Date.now() - 86400000).toISOString(), reporterName: "ด.ช.ตาวิเศษ รักดี" },
            { id: 2, name: "น.ส. ใจดี มีวินัย", studentId: "12346", classLevel: "ม.4/1", location: "หน้าอาคารเรียน", trashType: "กระดาษ/กล่องนม", timestamp: new Date(Date.now() - 172800000).toISOString(), reporterName: "นายจิตอาสา พัฒนา" },
        ];

        // --- App Logic ---
        const app = {
            state: {
                view: 'dashboard', 
                reports: [],
                students: [],
                config: {
                    locations: [],
                    trashTypes: [],
                    classLevels: []
                },
                isMobileMenuOpen: false,
                chartInstances: [],
                editingReportId: null
            },

            init() {
                // Load Reports
                const savedReports = localStorage.getItem('magicEyeReports');
                this.state.reports = savedReports ? JSON.parse(savedReports) : INITIAL_REPORTS;

                // Load Students
                const savedStudents = localStorage.getItem('magicEyeStudents');
                this.state.students = savedStudents ? JSON.parse(savedStudents) : INITIAL_STUDENTS;

                // Load Config
                const savedConfig = localStorage.getItem('magicEyeConfig');
                if (savedConfig) {
                    this.state.config = JSON.parse(savedConfig);
                } else {
                    this.state.config = {
                        locations: [...DEFAULT_LOCATIONS],
                        trashTypes: [...DEFAULT_TRASH_TYPES],
                        classLevels: [...DEFAULT_CLASS_LEVELS]
                    };
                }

                this.render();
            },

            saveData() {
                try {
                    localStorage.setItem('magicEyeReports', JSON.stringify(this.state.reports));
                    localStorage.setItem('magicEyeStudents', JSON.stringify(this.state.students));
                    localStorage.setItem('magicEyeConfig', JSON.stringify(this.state.config));
                } catch (e) {
                    alert("หน่วยความจำเต็ม ไม่สามารถบันทึกข้อมูลบางส่วนได้");
                }
            },

            setView(viewName) {
                this.state.view = viewName;
                if(viewName === 'report' && !this.state.editingReportId) {
                    // Clear edit mode if just clicking menu
                    this.state.editingReportId = null;
                }
                if(viewName !== 'report') {
                    this.state.editingReportId = null; // Exit edit mode when changing views
                }
                this.render();
                window.scrollTo(0, 0);
            },

            toggleMobileMenu() {
                this.state.isMobileMenuOpen = !this.state.isMobileMenuOpen;
                const menu = document.getElementById('mobile-menu');
                if (this.state.isMobileMenuOpen) {
                    menu.classList.remove('hidden');
                } else {
                    menu.classList.add('hidden');
                }
            },

            showNotification(msg = "บันทึกข้อมูลสำเร็จ!") {
                const el = document.getElementById('notification');
                const textEl = document.getElementById('notification-text');
                textEl.textContent = msg;
                el.classList.remove('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    el.classList.add('translate-x-full', 'opacity-0');
                }, 3000);
            },

            async addReport(formData) {
                const submitBtn = document.getElementById('submit-btn');
                const btnText = document.getElementById('submit-btn-text');
                const btnLoader = document.getElementById('submit-btn-loader');

                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                btnText.textContent = 'กำลังบันทึก...';
                btnLoader.classList.remove('hidden');

                if (this.state.editingReportId) {
                    // Update existing
                    const idx = this.state.reports.findIndex(r => r.id === this.state.editingReportId);
                    if (idx !== -1) {
                        const originalReport = this.state.reports[idx];
                        this.state.reports[idx] = {
                            ...originalReport,
                            ...formData,
                            // Preserve original timestamp or update? Usually preserve creation time for history
                            // timestamp: originalReport.timestamp 
                        };
                        this.saveData();
                        this.showNotification("แก้ไขข้อมูลเรียบร้อย");
                    }
                } else {
                    // Create new
                    const newReport = {
                        ...formData,
                        id: Date.now(),
                        timestamp: new Date().toISOString()
                    };

                    // Logic: ให้คะแนนความดีผู้แจ้ง
                    if (formData.reporterName) {
                        const reporterIndex = this.state.students.findIndex(s => s.name === formData.reporterName);
                        if (reporterIndex !== -1) {
                            this.state.students[reporterIndex].points = (this.state.students[reporterIndex].points || 0) + 1;
                        }
                    }

                    this.state.reports.unshift(newReport);
                    this.saveData();

                    // Send to Google Sheets only on new entries to avoid dupes/complexity
                    if (GOOGLE_SCRIPT_URL) {
                        try {
                            await fetch(GOOGLE_SCRIPT_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(newReport)
                            });
                        } catch (error) {
                            console.error("Error sending to Google Sheets:", error);
                        }
                    }
                    this.showNotification(`บันทึกสำเร็จ! ผู้แจ้งได้รับ +1 คะแนน`);
                }

                this.state.editingReportId = null;
                this.setView('search'); // Go to summary view
            },

            // --- Edit & Delete Logic ---
            editReport(id) {
                this.state.editingReportId = id;
                this.state.view = 'report';
                this.render();
                window.scrollTo(0, 0);
            },

            cancelEdit() {
                this.state.editingReportId = null;
                this.setView('search');
            },

            deleteReport(id) {
                if(confirm('คุณต้องการลบรายการนี้ใช่หรือไม่?')) {
                    this.state.reports = this.state.reports.filter(r => r.id !== id);
                    this.saveData();
                    this.render();
                    this.showNotification('ลบรายการเรียบร้อย');
                }
            },

            // --- Configuration Management ---
            addConfigItem(type, value) {
                if (!value.trim()) return;
                this.state.config[type].push(value.trim());
                this.saveData();
                this.render();
                this.showNotification(`เพิ่มรายการเรียบร้อย`);
            },

            removeConfigItem(type, index) {
                if (confirm("ต้องการลบรายการนี้? (ข้อมูลเก่าที่บันทึกแล้วจะไม่เปลี่ยนแปลง)")) {
                    this.state.config[type].splice(index, 1);
                    this.saveData();
                    this.render();
                }
            },

            resetConfig(type) {
                if (confirm("ต้องการรีเซ็ตเป็นค่าเริ่มต้น?")) {
                    if (type === 'locations') this.state.config.locations = [...DEFAULT_LOCATIONS];
                    if (type === 'trashTypes') this.state.config.trashTypes = [...DEFAULT_TRASH_TYPES];
                    if (type === 'classLevels') this.state.config.classLevels = [...DEFAULT_CLASS_LEVELS];
                    this.saveData();
                    this.render();
                }
            },

            // --- Student Management Logic ---
            addStudent(studentData) {
                this.state.students.push({
                    id: studentData.id || Date.now().toString(),
                    name: studentData.name,
                    classLevel: studentData.classLevel,
                    points: 0
                });
                this.saveData();
                this.render();
                this.showNotification("เพิ่มรายชื่อนักเรียนแล้ว");
            },

            deleteStudent(index) {
                if (confirm("ยืนยันการลบรายชื่อนี้?")) {
                    this.state.students.splice(index, 1);
                    this.saveData();
                    this.render();
                }
            },

            handleExcelImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        let count = 0;
                        let startIndex = 0;
                        if (jsonData[0] && (
                            (typeof jsonData[0][0] === 'string' && jsonData[0][0].includes('ชั้น')) ||
                            (typeof jsonData[0][3] === 'string' && jsonData[0][3].includes('ชื่อ'))
                        )) {
                            startIndex = 1;
                        }

                        for (let i = startIndex; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row[0] && row[3]) { 
                                const prefix = row[2] || '';
                                const firstName = row[3] || '';
                                const lastName = row[4] || '';
                                const fullName = `${prefix}${firstName} ${lastName}`.trim();
                                const classVal = row[0] || '-';

                                this.state.students.push({
                                    id: Date.now().toString() + i,
                                    name: fullName,
                                    classLevel: classVal,
                                    points: 0
                                });
                                count++;
                            }
                        }
                        this.saveData();
                        this.showNotification(`นำเข้าสำเร็จ ${count} รายชื่อ`);
                        this.render();
                    } catch (err) {
                        alert("เกิดข้อผิดพลาดในการอ่านไฟล์ Excel: " + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            },

            readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            // --- Chart Management ---
            destroyCharts() {
                this.state.chartInstances.forEach(chart => chart.destroy());
                this.state.chartInstances = [];
            },

            renderCharts() {
                if (this.state.view === 'awards') {
                    this.renderAwardsChart();
                } else if (this.state.view === 'executive') {
                    this.renderExecutiveCharts();
                }
            },

            renderAwardsChart() {
                const ctx = document.getElementById('awardsChart');
                if (!ctx) return;
                const stats = {};
                this.state.config.classLevels.forEach(c => stats[c] = 0);
                this.state.reports.forEach(r => {
                    if (stats[r.classLevel] !== undefined) stats[r.classLevel]++;
                    else stats[r.classLevel] = (stats[r.classLevel] || 0) + 1;
                });
                const sorted = Object.entries(stats).sort((a,b) => a[1] - b[1]);
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(i => i[0]),
                        datasets: [{
                            label: 'จำนวนครั้งที่ถูกแจ้งเหตุ',
                            data: sorted.map(i => i[1]),
                            backgroundColor: sorted.map(i => i[1] === 0 ? '#10b981' : (i[1] < 3 ? '#fbbf24' : '#ef4444')),
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
                this.state.chartInstances.push(chart);
            },

            renderExecutiveCharts() {
                const trashCtx = document.getElementById('trashChart');
                if (trashCtx) {
                    const trashStats = {};
                    this.state.reports.forEach(r => trashStats[r.trashType] = (trashStats[r.trashType] || 0) + 1);
                    this.state.chartInstances.push(new Chart(trashCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(trashStats),
                            datasets: [{ data: Object.values(trashStats), backgroundColor: ['#34d399', '#fbbf24', '#60a5fa', '#f87171', '#a78bfa', '#9ca3af'] }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                    }));
                }
                
                const locCtx = document.getElementById('locationChart');
                if (locCtx) {
                    const locStats = {};
                    this.state.reports.forEach(r => locStats[r.location] = (locStats[r.location] || 0) + 1);
                    const sortedLocs = Object.entries(locStats).sort((a,b) => b[1] - a[1]); 

                    this.state.chartInstances.push(new Chart(locCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedLocs.map(i => i[0]),
                            datasets: [{
                                label: 'จำนวนครั้ง',
                                data: sortedLocs.map(i => i[1]),
                                backgroundColor: '#f59e0b'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            plugins: { legend: { display: false } }
                        }
                    }));
                }

                const trendCtx = document.getElementById('trendChart');
                if (trendCtx) {
                    const days = {};
                    for(let i=6; i>=0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        const key = d.toLocaleDateString('th-TH', {day: 'numeric', month: 'short'});
                        days[key] = 0;
                    }

                    this.state.reports.forEach(r => {
                        const d = new Date(r.timestamp);
                        const key = d.toLocaleDateString('th-TH', {day: 'numeric', month: 'short'});
                        if (days[key] !== undefined) days[key]++;
                    });

                    this.state.chartInstances.push(new Chart(trendCtx, {
                        type: 'line',
                        data: {
                            labels: Object.keys(days),
                            datasets: [{
                                label: 'จำนวนการแจ้งเหตุ',
                                data: Object.values(days),
                                borderColor: '#10b981',
                                tension: 0.3,
                                fill: true,
                                backgroundColor: 'rgba(16, 185, 129, 0.1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, suggestedMax: 5 } }
                        }
                    }));
                }
            },

            // --- Render Functions ---

            render() {
                this.destroyCharts(); 
                const main = document.getElementById('main-content');
                main.innerHTML = ''; 

                switch (this.state.view) {
                    case 'dashboard': main.innerHTML = this.getDashboardHTML(); break;
                    case 'report': 
                        main.innerHTML = this.getReportFormHTML(); 
                        this.attachFormListeners(); 
                        break;
                    case 'search': 
                        main.innerHTML = this.getSearchHTML(); 
                        this.attachSearchListeners(); 
                        break;
                    case 'awards': main.innerHTML = this.getAwardsHTML(); break;
                    case 'executive': main.innerHTML = this.getExecutiveHTML(); break;
                    case 'students': 
                        main.innerHTML = this.getStudentManagerHTML(); 
                        this.attachStudentListeners();
                        break;
                    case 'settings':
                        main.innerHTML = this.getSettingsHTML();
                        this.attachSettingsListeners();
                        break;
                }

                lucide.createIcons();
                setTimeout(() => this.renderCharts(), 0);
            },

            getDashboardHTML() {
                const total = this.state.reports.length;
                const locCounts = {};
                this.state.reports.forEach(r => locCounts[r.location] = (locCounts[r.location] || 0) + 1);
                const topLocs = Object.entries(locCounts).sort((a,b) => b[1]-a[1]).slice(0,3);
                const renderList = (items) => items.length === 0 ? `<li class="text-sm text-gray-400">ยังไม่มีข้อมูล</li>` : items.map(([name, count], idx) => `<li class="flex justify-between items-center py-2 border-b last:border-0 border-gray-100"><span class="text-gray-700 text-sm"><span class="font-bold mr-2 text-emerald-600">#${idx+1}</span> ${name}</span><span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-bold">${count}</span></li>`).join('');
                const recentRows = this.state.reports.slice(0, 5).map(r => `<tr class="hover:bg-gray-50 border-b last:border-0 transition-colors"><td class="p-3 text-gray-500 text-xs">${new Date(r.timestamp).toLocaleDateString('th-TH')}</td><td class="p-3 text-gray-800 text-sm font-medium">${r.location}</td><td class="p-3 text-gray-600 text-sm">${r.trashType}</td><td class="p-3"><span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full text-xs font-bold">${r.classLevel}</span></td></tr>`).join('');
                return `<div class="space-y-6 animate-fade-in"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-gradient-to-br from-emerald-600 to-teal-700 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden"><div class="relative z-10"><h3 class="text-emerald-100 text-sm font-medium mb-1">สถิติการแจ้งเหตุรวม</h3><p class="text-5xl font-bold tracking-tight">${total}</p><p class="text-sm mt-2 opacity-80">ครั้งในภาคเรียนนี้</p></div><i data-lucide="bar-chart-2" class="absolute right-0 bottom-0 text-emerald-500 opacity-20 w-32 h-32 -mr-6 -mb-6"></i></div><div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100"><h3 class="text-gray-800 font-bold mb-4 flex items-center"><i data-lucide="alert-triangle" class="w-5 h-5 mr-2 text-orange-500"></i> จุดที่พบขยะบ่อยที่สุด</h3><ul>${renderList(topLocs)}</ul></div></div><div class="bg-white p-6 rounded-2xl shadow-md overflow-hidden border border-gray-100"><h3 class="font-bold text-gray-800 mb-4 flex items-center"><i data-lucide="clock" class="w-5 h-5 mr-2 text-blue-500"></i> รายการล่าสุด</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50 text-gray-600 font-medium border-b"><tr><th class="p-3 text-sm">เวลา</th><th class="p-3 text-sm">จุดที่พบ</th><th class="p-3 text-sm">ประเภท</th><th class="p-3 text-sm">ชั้น</th></tr></thead><tbody class="divide-y text-sm">${recentRows || '<tr><td colspan="4" class="p-4 text-center text-gray-400">ยังไม่มีข้อมูล</td></tr>'}</tbody></table></div></div></div>`;
            },

            getReportFormHTML() {
                const warningMsg = !GOOGLE_SCRIPT_URL ? `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 text-sm rounded shadow-sm"><p class="font-bold">⚠️ ยังไม่ได้เชื่อมต่อ Google Sheets</p></div>` : '';
                const options = (arr, selected) => arr.map(i => `<option value="${i}" ${i === selected ? 'selected' : ''}>${i}</option>`).join('');
                
                const isEditing = !!this.state.editingReportId;
                const editingReport = isEditing ? this.state.reports.find(r => r.id === this.state.editingReportId) : null;
                
                // For editing, we need to find the reporter's class to pre-select filtering
                let reporterClass = "";
                if (isEditing && editingReport.reporterName) {
                    const reporter = this.state.students.find(s => s.name === editingReport.reporterName);
                    if (reporter) reporterClass = reporter.classLevel;
                }

                return `
                    <div class="max-w-2xl mx-auto animate-fade-in pb-12">
                        ${warningMsg}
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i data-lucide="${isEditing ? 'edit' : 'plus-circle'}" class="mr-3 text-emerald-600 w-8 h-8"></i> ${isEditing ? 'แก้ไขการแจ้งเหตุ' : 'บันทึกการแจ้งเหตุ'}
                        </h2>
                        
                        ${!isEditing ? `
                        <div class="bg-amber-50 border border-amber-200 p-4 mb-6 rounded-xl shadow-sm relative">
                            <div class="absolute top-4 right-4 text-amber-300"><i data-lucide="quote" class="w-8 h-8"></i></div>
                            <h3 class="text-sm font-bold text-amber-800 flex items-center mb-2"><i data-lucide="message-circle" class="w-4 h-4 mr-2"></i>บทพูดสุภาพ (ตาวิเศษ)</h3>
                            <p class="text-amber-800 italic text-sm leading-relaxed">"ขออนุญาตแจ้งเตือนนะครับ/คะ โรงเรียนรณรงค์ให้ทิ้งขยะลงถัง เพื่อช่วยกันดูแลความสะอาดครับ/ค่ะ รบกวนช่วยเก็บไปทิ้งให้ถูกที่ด้วยนะครับ/คะ ขอบคุณครับ/ค่ะ"</p>
                        </div>` : ''}

                        <form id="report-form" class="bg-white p-6 rounded-2xl shadow-lg space-y-5 border border-gray-100">
                            
                            <!-- Reporter Section -->
                            <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                <label class="block text-sm font-bold text-emerald-800 mb-2 flex items-center">
                                    <i data-lucide="user" class="w-4 h-4 mr-2"></i> ผู้แจ้ง (รับ 1 คะแนนความดี)
                                </label>
                                <div class="grid grid-cols-2 gap-3 mb-2">
                                    <div>
                                        <select id="reporter-class-filter" class="w-full p-2 bg-white border border-emerald-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                                            <option value="">เลือกชั้น (ผู้แจ้ง)</option>
                                            ${options(this.state.config.classLevels, reporterClass)}
                                        </select>
                                    </div>
                                    <div>
                                        <select name="reporterName" id="reporter-name-select" ${isEditing ? '' : 'disabled'} class="w-full p-2 bg-gray-100 border border-emerald-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed">
                                            <option value="">-- เลือกชื่อ --</option>
                                        </select>
                                    </div>
                                </div>
                                <p class="text-xs text-emerald-600 mt-1">* หากไม่มีชื่อ ให้ไปเพิ่มที่เมนู "จัดการรายชื่อ"</p>
                            </div>

                            <hr class="border-gray-100">

                            <!-- Offender Section: Class Level First -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ระดับชั้น (ผู้ถูกแจ้ง/ทำผิด)</label>
                                <select name="classLevel" id="offender-class-select" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-all">
                                    <option value="">-- เลือกระดับชั้น --</option>${options(this.state.config.classLevels, isEditing ? editingReport.classLevel : '')}
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ชื่อ-นามสกุล (ผู้ถูกแจ้ง/ทำผิด)</label>
                                <select name="name" id="offender-name-select" required ${isEditing ? '' : 'disabled'} class="w-full p-3 bg-gray-100 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    <option value="">-- กรุณาเลือกระดับชั้นก่อน --</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">* ใช้ฐานข้อมูลเดียวกับผู้แจ้ง หากไม่พบชื่อ กรุณาเพิ่มในเมนู "จัดการรายชื่อ"</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">จุดที่พบ</label>
                                    <select name="location" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                                        <option value="">-- เลือกจุดที่พบ --</option>${options(this.state.config.locations, isEditing ? editingReport.location : '')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ประเภทขยะ</label>
                                    <select name="trashType" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                                        <option value="">-- เลือกประเภทขยะ --</option>${options(this.state.config.trashTypes, isEditing ? editingReport.trashType : '')}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">รายละเอียดเหตุการณ์ (เพิ่มเติม)</label>
                                <textarea name="details" rows="3" placeholder="ระบุรายละเอียดเพิ่มเติม (ไม่บังคับ)" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-all">${isEditing && editingReport.details ? editingReport.details : ''}</textarea>
                            </div>

                            <div class="pt-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">แนบรูปภาพ (ถ้ามี)</label>
                                <label for="image-input" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-emerald-50 hover:border-emerald-300 transition-all group">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <i data-lucide="image-plus" class="w-8 h-8 text-gray-400 group-hover:text-emerald-500 mb-2 transition-colors"></i>
                                        <p class="text-sm text-gray-500 group-hover:text-emerald-600">คลิกเพื่อเลือกรูปภาพ${isEditing ? 'ใหม่ (หากต้องการเปลี่ยน)' : ''}</p>
                                    </div>
                                    <input id="image-input" type="file" accept="image/*" class="hidden" />
                                </label>
                                <p id="file-name-display" class="text-xs text-emerald-600 mt-2 text-center font-medium hidden"></p>
                            </div>

                            <div class="flex gap-3">
                                ${isEditing ? `<button type="button" onclick="app.cancelEdit()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 rounded-xl shadow-md transition-all">ยกเลิก</button>` : ''}
                                <button id="submit-btn" type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-md hover:shadow-lg transition-all transform active:scale-95 flex justify-center items-center">
                                    <i data-lucide="loader-2" id="submit-btn-loader" class="hidden animate-spin mr-2 w-5 h-5"></i>
                                    <span id="submit-btn-text">${isEditing ? 'บันทึกการแก้ไข' : 'บันทึกข้อมูล'}</span>
                                </button>
                            </div>
                        </form>
                    </div>`;
            },

            attachFormListeners() {
                const form = document.getElementById('report-form');
                if (form) {
                    const fileInput = document.getElementById('image-input');
                    const fileNameDisplay = document.getElementById('file-name-display');
                    const isEditing = !!this.state.editingReportId;
                    const editingReport = isEditing ? this.state.reports.find(r => r.id === this.state.editingReportId) : null;

                    // --- Dynamic Dropdown Logic ---
                    const updateStudentDropdown = (classLevel, targetSelectId, selectedValue = null) => {
                        const targetSelect = document.getElementById(targetSelectId);
                        if (!targetSelect) return;

                        // Reset
                        targetSelect.innerHTML = '<option value="">-- เลือกรายชื่อ --</option>';
                        
                        if (!classLevel) {
                            targetSelect.disabled = true;
                            targetSelect.classList.add('bg-gray-100');
                            targetSelect.classList.remove('bg-white');
                            return;
                        }

                        // Filter students
                        const filteredStudents = this.state.students.filter(s => s.classLevel === classLevel);
                        
                        if (filteredStudents.length === 0) {
                            targetSelect.innerHTML = '<option value="">-- ไม่พบรายชื่อในชั้นนี้ --</option>';
                            targetSelect.disabled = true;
                        } else {
                            filteredStudents.sort((a, b) => a.name.localeCompare(b.name, 'th')); // Sort by name
                            filteredStudents.forEach(s => {
                                const option = document.createElement('option');
                                option.value = s.name;
                                option.textContent = s.name;
                                if(selectedValue && s.name === selectedValue) option.selected = true;
                                targetSelect.appendChild(option);
                            });
                            targetSelect.disabled = false;
                            targetSelect.classList.remove('bg-gray-100');
                            targetSelect.classList.add('bg-white');
                        }
                    };

                    // Listener for Reporter
                    const reporterClassFilter = document.getElementById('reporter-class-filter');
                    if (reporterClassFilter) {
                        reporterClassFilter.addEventListener('change', (e) => {
                            updateStudentDropdown(e.target.value, 'reporter-name-select');
                        });
                        // Trigger if editing and has value
                        if(isEditing && reporterClassFilter.value) {
                             updateStudentDropdown(reporterClassFilter.value, 'reporter-name-select', editingReport.reporterName);
                        }
                    }

                    // Listener for Offender
                    const offenderClassSelect = document.getElementById('offender-class-select');
                    if (offenderClassSelect) {
                        offenderClassSelect.addEventListener('change', (e) => {
                            updateStudentDropdown(e.target.value, 'offender-name-select');
                        });
                        // Trigger if editing and has value
                        if(isEditing && offenderClassSelect.value) {
                            updateStudentDropdown(offenderClassSelect.value, 'offender-name-select', editingReport.name);
                        }
                    }
                    // -----------------------------

                    if (fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            if (e.target.files.length > 0) {
                                fileNameDisplay.textContent = `เลือกไฟล์: ${e.target.files[0].name}`;
                                fileNameDisplay.classList.remove('hidden');
                            } else {
                                fileNameDisplay.classList.add('hidden');
                            }
                        });
                    }
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());
                        if (fileInput && fileInput.files[0]) {
                            try { data.image = await this.readFileAsDataURL(fileInput.files[0]); } catch (err) {}
                        }
                        this.addReport(data);
                    });
                }
            },

            getSearchHTML() {
                return `
                    <div class="max-w-4xl mx-auto animate-fade-in pb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i data-lucide="list-checks" class="mr-3 text-emerald-600 w-8 h-8"></i> สรุปรายการแจ้งเหตุ
                        </h2>
                        
                        <div class="bg-white p-4 rounded-2xl shadow-md mb-8 border border-gray-200 sticky top-20 z-10">
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i>
                                <input id="search-input" type="text" placeholder="ค้นหาชื่อ, ชั้น, หรือ ประเภทขยะ..." class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none text-gray-700">
                            </div>
                        </div>

                        <div id="search-results" class="space-y-8">
                            <div class="flex flex-col items-center justify-center text-gray-400 py-12">
                                <i data-lucide="search" class="w-16 h-16 mb-4 opacity-20"></i>
                                <p>กำลังโหลดรายการ...</p>
                            </div>
                        </div>
                    </div>`;
            },

            attachSearchListeners() {
                const input = document.getElementById('search-input');
                const resultsDiv = document.getElementById('search-results');

                const renderReports = (filter = "") => {
                    const term = filter.toLowerCase();
                    let filtered = this.state.reports.filter(r => 
                        r.name.toLowerCase().includes(term) || 
                        r.classLevel.toLowerCase().includes(term) ||
                        (r.reporterName && r.reporterName.toLowerCase().includes(term)) ||
                        r.trashType.toLowerCase().includes(term)
                    );

                    if (filtered.length === 0) { 
                        resultsDiv.innerHTML = '<div class="text-center text-gray-500 py-8">ไม่พบข้อมูล</div>'; 
                        return; 
                    }

                    // Group by Date
                    const grouped = {};
                    filtered.forEach(r => {
                        const dateKey = new Date(r.timestamp).toLocaleDateString('th-TH', {
                            year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
                        });
                        if (!grouped[dateKey]) grouped[dateKey] = [];
                        grouped[dateKey].push(r);
                    });

                    // Sort Dates descending (assuming timestamp logic holds)
                    // Since grouped keys are strings, we rely on the report order which is usually new-to-old.
                    // Or we can assume filtered is already sorted by date desc.
                    
                    let html = "";
                    for (const date in grouped) {
                        html += `
                            <div class="animate-fade-in">
                                <h3 class="text-sm font-bold text-gray-500 mb-3 bg-gray-100 inline-block px-3 py-1 rounded-full border border-gray-200 sticky top-0">
                                    ${date}
                                </h3>
                                <div class="space-y-3">
                        `;
                        
                        grouped[date].forEach(r => {
                            html += `
                                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative group hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="bg-emerald-100 text-emerald-800 text-xs font-bold px-2 py-1 rounded">${r.classLevel}</span>
                                            <span class="text-xs text-gray-400 flex items-center"><i data-lucide="clock" class="w-3 h-3 mr-1"></i>${new Date(r.timestamp).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</span>
                                        </div>
                                        <div class="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onclick="app.editReport(${r.id})" class="text-blue-500 hover:text-blue-700 p-1 bg-blue-50 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                            <button onclick="app.deleteReport(${r.id})" class="text-red-500 hover:text-red-700 p-1 bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-bold text-gray-800 text-lg">${r.name}</h4>
                                            <p class="text-sm text-gray-600 mt-1">
                                                <span class="font-semibold text-gray-500">พบที่:</span> ${r.location} 
                                                <span class="mx-2 text-gray-300">|</span>
                                                <span class="font-semibold text-gray-500">ขยะ:</span> ${r.trashType}
                                            </p>
                                            ${r.details ? `<p class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded">"${r.details}"</p>` : ''}
                                            <p class="text-xs text-emerald-600 mt-2 flex items-center">
                                                <i data-lucide="user-check" class="w-3 h-3 mr-1"></i> แจ้งโดย: ${r.reporterName || '-'}
                                            </p>
                                        </div>
                                        ${r.image ? `<div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden border border-gray-200 flex-shrink-0 ml-2"><img src="${r.image}" class="w-full h-full object-cover" alt="หลักฐาน"></div>` : ''}
                                    </div>
                                </div>
                            `;
                        });

                        html += `</div></div><div class="h-4"></div>`;
                    }
                    resultsDiv.innerHTML = html;
                    lucide.createIcons();
                };

                // Initial Render
                renderReports();

                input.addEventListener('input', (e) => {
                    renderReports(e.target.value);
                });
            },

            getSettingsHTML() {
                const renderList = (items, type) => items.map((item, idx) => `
                    <div class="flex justify-between items-center p-2 hover:bg-gray-50 border-b last:border-0 border-gray-100">
                        <span class="text-sm text-gray-700">${item}</span>
                        <button onclick="app.removeConfigItem('${type}', ${idx})" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                `).join('');

                const renderCard = (title, icon, type, items, placeholder) => `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700 flex items-center text-sm"><i data-lucide="${icon}" class="w-4 h-4 mr-2"></i>${title}</h3>
                            <button onclick="app.resetConfig('${type}')" class="text-xs text-blue-500 hover:text-blue-700 underline">รีเซ็ต</button>
                        </div>
                        <div class="max-h-60 overflow-y-auto">
                            ${renderList(items, type)}
                        </div>
                        <div class="p-3 border-t border-gray-100">
                            <form onsubmit="event.preventDefault(); app.addConfigItem('${type}', this.elements[0].value); this.reset();" class="flex gap-2">
                                <input type="text" placeholder="${placeholder}" required class="flex-1 p-2 text-sm border rounded focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                                <button type="submit" class="bg-emerald-600 text-white px-3 rounded hover:bg-emerald-700"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </form>
                        </div>
                    </div>
                `;

                return `
                    <div class="max-w-4xl mx-auto animate-fade-in pb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i data-lucide="settings" class="mr-3 text-emerald-600 w-8 h-8"></i> ตั้งค่าตัวเลือก
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            ${renderCard('ระดับชั้น', 'users', 'classLevels', this.state.config.classLevels, 'เช่น ม.1/4')}
                            ${renderCard('จุดที่พบ', 'map-pin', 'locations', this.state.config.locations, 'เช่น หน้าห้องสมุด')}
                            ${renderCard('ประเภทขยะ', 'trash', 'trashTypes', this.state.config.trashTypes, 'เช่น โฟม')}
                        </div>
                    </div>
                `;
            },

            attachSettingsListeners() {
                // Listeners are inline (onsubmit) for simplicity in this generated view
            },

            getStudentManagerHTML() {
                const studentListHTML = this.state.students.length === 0 ? 
                    `<tr><td colspan="4" class="p-6 text-center text-gray-400">ยังไม่มีรายชื่อนักเรียน</td></tr>` :
                    this.state.students.map((s, idx) => `
                        <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                            <td class="p-3 text-sm">${idx + 1}</td>
                            <td class="p-3 text-sm font-medium text-gray-800">${s.name}</td>
                            <td class="p-3 text-sm text-gray-600">${s.classLevel}</td>
                            <td class="p-3 text-center">
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-bold">${s.points || 0} คะแนน</span>
                            </td>
                            <td class="p-3 text-right">
                                <button onclick="app.deleteStudent(${idx})" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    `).join('');

                return `
                    <div class="max-w-4xl mx-auto animate-fade-in pb-12">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                <i data-lucide="users" class="mr-3 text-emerald-600 w-8 h-8"></i> จัดการรายชื่อนักเรียน
                            </h2>
                            <div class="text-sm text-gray-500">
                                ทั้งหมด: <span class="font-bold text-emerald-600">${this.state.students.length}</span> คน
                            </div>
                        </div>

                        <!-- Import & Add Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            <!-- Import Excel -->
                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-emerald-100">
                                <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="file-spreadsheet" class="mr-2 w-5 h-5 text-green-600"></i> นำเข้าไฟล์ Excel</h3>
                                <p class="text-xs text-gray-500 mb-4 bg-gray-50 p-2 rounded border border-gray-100">
                                    <strong>รูปแบบคอลัมน์:</strong><br>
                                    A=ชั้นเรียน, B=เลขที่, C=คำนำหน้า, D=ชื่อ, E=นามสกุล
                                </p>
                                <label class="block w-full text-center p-3 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-emerald-400 transition-colors">
                                    <span class="text-sm text-gray-500" id="excel-label">คลิกเพื่อเลือกไฟล์ .xlsx</span>
                                    <input type="file" id="excel-input" accept=".xlsx, .xls" class="hidden">
                                </label>
                            </div>

                            <!-- Manual Add -->
                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="user-plus" class="mr-2 w-5 h-5 text-blue-600"></i> เพิ่มรายชื่อทีละคน</h3>
                                <form id="add-student-form" class="flex gap-2">
                                    <input type="text" name="name" required placeholder="ชื่อ-สกุล" class="flex-1 p-2 bg-gray-50 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <input type="text" name="classLevel" required placeholder="ชั้น" class="w-20 p-2 bg-gray-50 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <button type="submit" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"><i data-lucide="plus" class="w-5 h-5"></i></button>
                                </form>
                            </div>
                        </div>

                        <!-- Student List -->
                        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                            <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="font-bold text-gray-700">รายชื่อนักเรียนและคะแนนความดี</h3>
                                <input type="text" id="student-filter" placeholder="ค้นหาชื่อ..." class="p-2 border rounded-lg text-sm w-48 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div class="overflow-x-auto max-h-[500px]">
                                <table class="w-full text-left">
                                    <thead class="bg-gray-100 text-gray-600 font-medium sticky top-0 z-10">
                                        <tr>
                                            <th class="p-3 text-sm w-12">#</th>
                                            <th class="p-3 text-sm">ชื่อ-นามสกุล</th>
                                            <th class="p-3 text-sm w-24">ชั้น</th>
                                            <th class="p-3 text-sm w-24 text-center">คะแนน</th>
                                            <th class="p-3 text-sm w-16 text-right">ลบ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="student-table-body" class="divide-y text-gray-700">
                                        ${studentListHTML}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },

            attachStudentListeners() {
                // Excel Import
                const excelInput = document.getElementById('excel-input');
                if (excelInput) excelInput.addEventListener('change', (e) => this.handleExcelImport(e));

                // Manual Add
                const addForm = document.getElementById('add-student-form');
                if (addForm) {
                    addForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const data = new FormData(addForm);
                        this.addStudent({
                            name: data.get('name'),
                            classLevel: data.get('classLevel')
                        });
                        addForm.reset();
                    });
                }
                
                // Filter
                const filterInput = document.getElementById('student-filter');
                if (filterInput) {
                    filterInput.addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        const rows = document.querySelectorAll('#student-table-body tr');
                        rows.forEach(row => {
                            const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                            if (name.includes(term)) row.style.display = '';
                            else row.style.display = 'none';
                        });
                    });
                }
            },
            
            // ... existing functions ...
            
            handleExcelImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        // header: 1 means array of arrays
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        let count = 0;
                        let startIndex = 0;

                        // Check if first row is header
                        // Check if row[0] contains "ชั้น" or row[3] contains "ชื่อ"
                        if (jsonData[0] && (
                            (typeof jsonData[0][0] === 'string' && jsonData[0][0].includes('ชั้น')) ||
                            (typeof jsonData[0][3] === 'string' && jsonData[0][3].includes('ชื่อ'))
                        )) {
                            startIndex = 1;
                        }

                        // Column Mapping:
                        // A [0] = Class
                        // B [1] = Number (Not used for display, but could be ID part)
                        // C [2] = Prefix
                        // D [3] = FirstName
                        // E [4] = LastName

                        for (let i = startIndex; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            // Must have at least Class (0) and First Name (3)
                            if (row[0] && row[3]) { 
                                const prefix = row[2] || '';
                                const firstName = row[3] || '';
                                const lastName = row[4] || '';
                                const fullName = `${prefix}${firstName} ${lastName}`.trim();
                                const classVal = row[0] || '-';

                                this.state.students.push({
                                    id: Date.now().toString() + i, // Generate unique ID
                                    name: fullName,
                                    classLevel: classVal,
                                    points: 0
                                });
                                count++;
                            }
                        }
                        this.saveData();
                        this.showNotification(`นำเข้าสำเร็จ ${count} รายชื่อ`);
                        this.render();
                    } catch (err) {
                        alert("เกิดข้อผิดพลาดในการอ่านไฟล์ Excel: " + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            },
        };

        // Start App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
    
    <!-- Animation CSS -->
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</body>
</html>